# Task 31 — Окружение города (деревья, фонари, бордюры)

## Цель
Добавить объекты окружения для создания атмосферы городской сцены: деревья, уличные фонари, бордюры.

## Описание
Реализованы три типа объектов окружения для оживления сцены:

### 1. Деревья (Trees)
- **Количество**: 9 деревьев (1 ель + 8 разных лиственных)
- **Типы**:
  - Тип 1: Сферическая крона (лиственные)
  - Тип 2: Коническая крона (ель/сосна)
  - Тип 3: Двухуровневая крона (смешанные)
- **Размещение**:
  - 1 ель в центре: позиция (13, 10)
  - 8 дополнительных деревьев:
    - Верхний левый: (-17, 10), (-13, 10)
    - Верхний правый: (17, 10)
    - Нижний левый: (-17, -10), (-14, -10), (-10, -10)
    - Нижний правый: (7, -10)
    - Дополнительное: (-14, -7)
- **Зона размещения**: ТОЛЬКО на зелёной траве (за пределами бетонных полос с зданиями)
- **Характеристики**:
  - Ствол: коричневый цилиндр (`0x5d4037`)
  - Крона: 3 оттенка зелёного (`0x2d5016`, `0x1b5e20`, `0x33691e`)
  - Случайный масштаб: 0.7-1.3
  - Случайный поворот для естественности
  - Отбрасывают и принимают тени

### 2. Уличные фонари (Street Lights)
- **Модель**: `light-square.glb` из Kenney Roads Kit
- **Количество**: 4 фонаря
- **Позиции**: на углах перекрестка (где бордюры встречаются):
  - Правый верхний: (2.5, 2.5)
  - Левый верхний: (-2.5, 2.5)
  - Правый нижний: (2.5, -2.5)
  - Левый нижний: (-2.5, -2.5)
- **Ориентация**: Все фонари смотрят на центр перекрестка (0.5, 0.5)
  - Вычисление угла: `Math.atan2(centerX - pos.x, centerZ - pos.z)`
  - Динамический расчёт rotation для каждого фонаря
- **Размер**: масштабирован до ~1.5 единиц высоты
- **Текстура**: `colormap.png` из Roads Kit с удалением vertex colors

### 3. Бордюры (Curbs)
- **Цель**: визуальное разделение дороги от бетонных тротуаров
- **Цвет**: светло-серый (`0xa0a0a0`)
- **Размеры**: ширина 0.5, высота 0.1
- **Позиция по Y**: 0.04 (ниже дороги на 0.05)
- **Размещение**:
  - 4 бордюра вдоль вертикальной дороги: X = ±2
  - 4 бордюра вдоль горизонтальной дороги: Z = ±2
- **Материал**: `MeshStandardMaterial` с низкой metalness

## Технические детали

### Методы в MapScene.ts

```typescript
// Создание одного дерева
private createTree(type: number, scale = 1): THREE.Group {
  const tree = new THREE.Group();
  // type: 1 = сферическая, 2 = коническая, 3 = двухуровневая
  // Ствол: CylinderGeometry
  // Крона: SphereGeometry / ConeGeometry
  return tree;
}

// Размещение деревьев
private populateTrees(): void {
  // 1 ель в центре
  // + 8 дополнительных деревьев по точкам
}

// Размещение фонарей
private async addStreetLights(): Promise<void> {
  // Загрузка GLB и текстуры
  // 4 фонаря с динамической ориентацией на центр
}

// Создание дорог с бордюрами
private buildPrimitiveRoads(): void {
  // Дорога: BoxGeometry (ширина 3.5, высота 0.1)
  // Бордюры: BoxGeometry (ширина 0.5, высота 0.1)
  // Позиционирование: дорога y=0.05, бордюры y=0.04
}
```

### Слои высот (Y-координаты)
- **Земля (grass)**: y = 0
- **Бетонные тротуары**: y = 0.01
- **Бордюры**: y = 0.04
- **Дорога**: y = 0.05
- **Разметка**: y = 0.06
- **Машинка**: y = 0.6
- **Фонари**: y = 0 (на земле)
- **Деревья**: y = 0 (на земле)

## История разработки

### Деревья
1. **Первая попытка** (02.10.2025): 60 деревьев случайно по всей карте
   - **Проблема**: деревья попадали на бетонные зоны с зданиями и дорогу
   - **Решение**: переопределены зоны размещения за пределами бетона

2. **Вторая попытка**: 5 елей в ряд + прудик
   - **Проблема**: прудик выглядел как "бассейн" (слишком искусственно)
   - **Решение**: прудик удалён, оставлены только деревья

3. **Финальная версия**: 1 ель + 8 разных деревьев
   - Точечное размещение по координатам
   - Разные типы крон для разнообразия
   - ТОЛЬКО на зелёной траве

### Фонари
1. **Первая версия**: статические углы поворота (`Math.PI * 1.25`, etc.)
   - **Проблема**: не все фонари смотрели на перекрёсток
   - **Решение**: динамический расчёт `atan2` для каждого фонаря

2. **Финальная версия**: фонари смотрят на центральную точку (0.5, 0.5)
   - Вычисление: `rotation = Math.atan2(centerX - pos.x, centerZ - pos.z)`
   - Все 4 фонаря корректно направлены к центру

### Бордюры
1. **Первая попытка**: широкие бордюры (ширина 1.5)
   - **Проблема**: слишком массивные, визуально странные
   - **Решение**: уменьшены до 0.5 единиц

2. **Вторая попытка**: бордюры на высоте дороги (y=0.06)
   - **Проблема**: бордюры "сверху" от дороги
   - **Решение**: опущены ниже дороги (y=0.04)

3. **Финальная версия**: узкие светло-серые бордюры под дорогой
   - Создают тонкую визуальную границу
   - Не перекрывают дорогу

## Acceptance
- [x] 9 деревьев размещены на зелёных зонах (не на бетоне/дороге)
- [x] Деревья имеют 3 разных типа крон
- [x] Деревья разного масштаба и поворота для естественности
- [x] 4 фонаря на углах перекрестка
- [x] Все фонари смотрят на центр перекрестка (0.5, 0.5)
- [x] Фонари загружены из GLB с текстурой
- [x] Бордюры размещены вдоль дорог
- [x] Бордюры находятся ниже уровня дороги (y=0.04)
- [x] Все элементы отбрасывают и принимают тени

## Источники моделей
- **Фонари**: Kenney Roads Kit → `light-square.glb`
- **Деревья**: процедурно созданы из примитивов Three.js (CylinderGeometry + SphereGeometry/ConeGeometry)
- **Лицензия**: Kenney Assets - CC0 (Public Domain)

## Оценка
~3 часа (включая итерации и исправления)

## Файлы
- `src/game/MapScene.ts` - все методы создания окружения
- Ассеты:
  - `src/assets/roads/Models/GLB format/light-square.glb`
  - `src/assets/roads/Models/GLB format/Textures/colormap.png`

