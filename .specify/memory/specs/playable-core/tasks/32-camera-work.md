# Task 32 — Проработка камеры и приближение (Camera Work & Zoom-in)

## Цель
Улучшить работу камеры для более динамичного и кинематографичного восприятия игры: приблизить камеру к действию, добавить плавное следование за машинкой, эффекты zoom-in/out при старте и финише.

## Описание
Сейчас камера статична с `BASE_VIEW_SIZE = 10` и просто центрируется на сцене. Нужно сделать камеру более живой и динамичной.

## Требования

### 1. Приближение камеры (Zoom-in)
- **Текущее состояние**: `BASE_VIEW_SIZE = 10` — слишком далеко, вся сцена видна
- **Цель**: уменьшить `BASE_VIEW_SIZE` до 6-7 для более кинематографичного вида
- **Адаптация**: сохранить полное покрытие viewport при любом соотношении сторон
- **Проверка**: земля и дороги должны по-прежнему покрывать весь экран

### 2. Следование за машинкой (Camera Follow)
- **Режим "следование"**: камера плавно двигается вслед за машинкой во время движения
- **Lerp-интерполяция**: `camera.position.lerp(carPosition, lerpFactor)` для плавности
- **Параметры**:
  - `lerpFactor`: 0.05-0.1 (чем меньше, тем плавнее)
  - Offset по Y: камера смотрит немного "вперёд" по маршруту
- **Границы**: камера не выходит за пределы дороги (clamp по X/Z)

### 3. Эффект Zoom-in на старте
- **Момент**: после выбора маршрута (first_interact)
- **Эффект**: камера плавно приближается от `BASE_VIEW_SIZE = 10` до `BASE_VIEW_SIZE = 6`
- **Длительность**: 0.5-1 секунда
- **Easing**: ease-out для естественности

### 4. Эффект Zoom-out на финише
- **Момент**: когда машинка достигает финальной точки (level_complete)
- **Эффект**: камера отдаляется до `BASE_VIEW_SIZE = 12` для обзора всей сцены
- **Длительность**: 1-1.5 секунды
- **Цель**: показать весь пройденный путь и окружение

### 5. Статичная камера на выборе маршрута
- **Момент**: до first_interact (начальное состояние)
- **Позиция**: центр сцены, `BASE_VIEW_SIZE = 10`
- **Цель**: дать игроку обзор всей карты для выбора маршрута

## Технические детали

### Структура в ThreeRenderer.ts

```typescript
export default class ThreeRenderer {
  private baseViewSize = 10; // начальное значение
  private targetViewSize = 10; // для анимации zoom
  private cameraLerpFactor = 0.08; // скорость следования
  private followTarget?: THREE.Vector3; // цель для следования
  private isFollowingCar = false;
  
  // Новые методы
  public setCameraFollow(target: THREE.Vector3 | null): void {
    // Включить/выключить режим следования
  }
  
  public animateZoom(targetSize: number, duration: number): void {
    // Плавный zoom с easing
  }
  
  public updateCamera(deltaTime: number): void {
    // В render loop:
    // 1. Обновить zoom (если идёт анимация)
    // 2. Обновить позицию (если следует за машинкой)
    // 3. Обновить OrthographicCamera размеры
  }
}
```

### Интеграция с MapScene.ts

```typescript
// При выборе маршрута (first_interact)
private onRouteSelected(direction: 'left' | 'right' | 'straight'): void {
  // 1. Запустить zoom-in
  this.renderer.animateZoom(6, 800); // 0.8 секунды
  
  // 2. Включить следование за машинкой
  this.renderer.setCameraFollow(this.car.getPosition());
  
  // 3. Запустить движение машинки
  this.car.moveTo(route);
}

// При достижении финала (onArrival)
private onCarArrival(): void {
  // 1. Выключить следование
  this.renderer.setCameraFollow(null);
  
  // 2. Запустить zoom-out
  this.renderer.animateZoom(12, 1200); // 1.2 секунды
  
  // 3. Отправить событие level_complete
}
```

### Параметры для настройки

```typescript
// Оптимальные значения (можно подобрать в процессе)
const CAMERA_CONFIG = {
  initial: {
    viewSize: 10,    // начальный обзор (выбор маршрута)
    position: { x: 0, y: 20, z: 0 }
  },
  gameplay: {
    viewSize: 6,     // приближение во время игры
    lerpFactor: 0.08, // плавность следования (0.05-0.15)
    offsetZ: 2       // смещение "вперёд" по движению
  },
  finale: {
    viewSize: 12,    // отдаление на финише
    duration: 1200   // ms
  },
  zoomIn: {
    duration: 800    // ms для zoom-in на старте
  }
};
```

### Easing функция

```typescript
// Ease-out cubic для плавного замедления
function easeOutCubic(t: number): number {
  return 1 - Math.pow(1 - t, 3);
}
```

## Статус: В процессе

### Реализовано (05.10.2025)
✅ **Приближение камеры (Zoom-in)**:
- Изменен `BASE_VIEW_SIZE` с 10 на 5 (zoom-in в 2 раза)
- Камера теперь показывает сцену в 2 раза ближе
- Адаптивность работает корректно при любом соотношении сторон
- **Файл**: `src/renderer/ThreeRenderer.ts`

✅ **Следование камеры за машиной**:
- Реализован метод `updateCameraFollow()` для ортографической камеры
- Камера плавно следует за машиной с изометрическим углом обзора
- Используется lerp-интерполяция с коэффициентом 0.1 для плавности
- Камера позиционируется **позади машинки** (`cameraOffset = 10` по оси Z)
- Камера смотрит **на машинку** (`lookAt`), создавая наклон для обзора города
- Высота камеры (Y = 15) остается неизменной
- При инициализации камера сразу устанавливается за машинкой
- При смене ориентации камера мгновенно перемещается за машинкой
- **Файл**: `src/game/MapScene.ts`

⚠️ **Примечание**: Для ортографической камеры следование реализуется через смещение центра камеры, а не через изменение lookAt или rotation.

### Осталось реализовать
- [ ] Zoom-in эффект на старте (после выбора маршрута)
- [ ] Zoom-out эффект на финише
- [ ] Настройка границ камеры (не выходить за пределы)
- [ ] Адаптация BASE_VIEW_SIZE для режима follow

## Acceptance
- [x] Камера плавно следует за машинкой (lerp-интерполяция)
- [x] Камера приближена: `BASE_VIEW_SIZE = 5` во время игры (в 2 раза ближе)
- [ ] Zoom-in эффект работает после выбора маршрута (0.5-1 сек)
- [ ] Zoom-out эффект работает на финише (1-1.5 сек)
- [ ] Статичная камера на начальном экране (выбор маршрута)
- [ ] Камера не выходит за границы дороги
- [x] Земля и дороги покрывают весь viewport при любом zoom
- [x] 60 FPS сохраняется при всех анимациях камеры
- [x] Адаптивность работает при любом соотношении сторон

## Зависимости
- ✅ Task 08 — Render Engine (ThreeRenderer.ts)
- ✅ Task 09 — Map Scene (MapScene.ts)
- ✅ Task 10 — Car Sprite (CarSprite.ts)
- ⏳ Task 11 — Obstacles (для полноценного тестирования)
- ⏳ Task 12 — Route Selection (для триггера zoom-in)

## Риски
1. **Производительность**: частое обновление камеры может снизить FPS
   - **Митигация**: оптимизировать lerp, использовать `requestAnimationFrame` правильно
2. **Выход за границы**: при zoom-in земля может не покрывать viewport
   - **Митигация**: увеличить коэффициент `extendFactor` для земли/дорог
3. **Дизориентация**: слишком резкие движения камеры
   - **Митигация**: подобрать оптимальные значения `lerpFactor` и `duration`

## Тестирование
1. **Portrait режим**: камера следует за машинкой от start-3 до road-top-5
2. **Landscape режим**: камера следует за машинкой от road-bottom-1 до road-top-2
3. **Смена ориентации**: камера корректно пересчитывается при resize
4. **Границы**: камера не показывает пустоту за пределами земли/дорог

## Альтернативные подходы
1. **Фиксированная камера с padding**: не следовать за машинкой, но приблизить zoom
   - Проще реализовать, но менее динамично
2. **Shake эффект**: добавить небольшое дрожание камеры при движении
   - Для большей кинематографичности, но может раздражать
3. **Smooth-step**: использовать smoothstep вместо lerp для более "органичного" движения

## Оценка
~2-3 часа (включая подбор параметров и тестирование)

## Приоритет
🔥 **HIGH** — камера критически важна для восприятия игры

## Файлы
- `src/renderer/ThreeRenderer.ts` — основная логика камеры
- `src/game/MapScene.ts` — интеграция с геймплеем
- `src/game/CarSprite.ts` — источник позиции для следования

